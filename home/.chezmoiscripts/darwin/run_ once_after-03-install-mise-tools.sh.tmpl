{{- if (eq .chezmoi.os "darwin") -}}
#!/bin/sh

# Install mise tools (modern replacement for asdf)

source /tmp/chezmoi-utils.sh

printf "${green}[03 - Mise Tools] ${reset}"
{{- if or (lt 03 (atoi (env "SCRIPTS_START_AT"))) (env "SKIP_MISE_TOOLS") }}
echo "Skip installing mise tools"
exit 0
{{ else }}
echo "Install mise tools"
{{- end }}

set -eufo pipefail

# Check if mise is available
if ! command -v mise &> /dev/null; then
  echo "Mise not found in PATH. Trying to source Homebrew environment..."
  # Try to add Homebrew to PATH
  if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -f "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
  
  # Check again
  if ! command -v mise &> /dev/null; then
    echo "Error: mise still not found. Please ensure Homebrew packages were installed correctly."
    exit 1
  fi
fi

# Configure mise
mise settings set experimental true

# Install latest stable versions (ignore existing .tool-versions for now)
echo "Installing latest stable versions of common tools"
# Install latest versions of commonly used tools that are known to work
mise use --global node@lts
mise use --global python@latest  
mise use --global ruby@3.3
mise use --global java@openjdk-21

# Note: If you have an existing .tool-versions file, you can run 'mise install' later
# to install those specific versions after ensuring they're compatible

# Verify installations
echo "Verifying mise installations:"
mise list --current

# Install global packages if needed
{{ $rubyPackages := list
}}

{{ range sortAlpha $rubyPackages }}
gem install {{ . }}
{{ end -}}

echo "Mise tool installation complete!"

{{ end -}}
