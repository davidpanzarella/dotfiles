# .zshrc is sourced in interactive shells.
# It should contain commands to set up aliases, functions, options, key bindings, etc.
# https://unix.stackexchange.com/questions/71253/what-should-shouldnt-go-in-zshenv-zshrc-zlogin-zprofile-zlogout
# https://www.youtube.com/watch?v=MSPu-lYF-A8

# Initialize Starship prompt (works in all terminals)
if command -v starship &> /dev/null; then
  eval "$(starship init zsh)"
fi

# setopt appendhistory

# some useful options (man zshoptions)
# setopt autocd extendedglob nomatch menucomplete
# setopt interactive_comments

# beeping is annoying
# unsetopt BEEP


# # completions
# autoload -Uz compinit
# zstyle ':completion:*' menu select
# # zstyle ':completion::complete:lsof:*' menu yes select
# zmodload zsh/complist
# # compinit
# _comp_options+=(globdots)		# Include hidden files.

# Path to your oh-my-zsh installation.
export ZSH=$HOME/.oh-my-zsh

# No theme needed - starship handles the prompt
ZSH_THEME=""

# fzf configurations
export FZF_DEFAULT_OPTS='--height 40% --layout=reverse --border'
# Uncomment the following line to disable fuzzy completion
# export DISABLE_FZF_AUTO_COMPLETION="true"
# Uncomment the following line to disable key bindings (CTRL-T, CTRL-R, ALT-C)
# export DISABLE_FZF_KEY_BINDINGS="true"
# disable sort when completing `git checkout`
zstyle ':completion:*:git-checkout:*' sort false
# set descriptions format to enable group support
zstyle ':completion:*:descriptions' format '[%d]'
# set list-colors to enable filename colorizing
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
# preview directory's content with exa when completing cd
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'exa -1 --color=always $realpath'
# switch group using `,` and `.`
zstyle ':fzf-tab:*' switch-group ',' '.'

# Which plugins would you like to load? (plugins can be found in ~/.dotfiles/oh-my-zsh/plugins/*)
plugins=(
  1password
  aliases
  # mise integration handled separately
  brew                    # Aliases for [Homebrew](https://brew.sh/)
  colorize
  command-not-found 
  compleat
  cp
  colorize                # Adds colors to common commands
  colored-man-pages       # Adds colors to man pages
  common-aliases          # Aliases for many commonly used commands
  copybuffer              # Copy buffer to clipboard
  copyfile                # Copy file to clipboard
  copypath                # Copy path to clipboard 
  cp                      # Secure `cpv` function that uses `rsync`
  dirhistory              # Directory history
  dirpersist
  docker                  # Aliases for [Docker](https://www.docker.com/)
  docker-compose          # Aliases for [Docker-Compose](https://docs.docker.com/compose/)
  dotenv                 # Load project ENV variables from folder `.env` files
  emoji                   # Emoji completion
  extract                 # Multi-format decompression function `x`
  fzf
  fzf-tab                 # to turn it on and off: toggle-fzf-tab
  gatsby                  # Aliases for [Gatsby](https://www.gatsbyjs.org/)
  gh
  git
  history-substring-search  # Search through your command history
  history                 # Aliases for `history` command
  jsontools               # JSON tools
  kubectl                 # Aliases for [Kubernetes](https://kubernetes.io/)
  macos
  node
  npm
  pip
  pj                      # Project Jump folder shortcuts
  python
  safe-paste  
  sudo                    # Aliases for `sudo` command
  web-search              # Search the web from the command line
  yarn
  z                       # Tracks your most used directories.
  zsh-autosuggestions     # Command suggestions based on history and completions (https://github.com/zsh-users/zsh-autosuggestions)
  zsh-syntax-highlighting # Fish shell like syntax highlighting (https://github.com/zsh-users/zsh-syntax-highlighting)
  vscode
)


# Mise (modern replacement for asdf)
if command -v mise &> /dev/null; then
  eval "$(mise activate zsh)"
fi

# Load oh-my-zsh
source $ZSH/oh-my-zsh.sh

# Load functions and aliases after oh-my-zsh
source "$ZDOTDIR/zsh-functions"
zsh_add_file "zsh-aliases"

# Load direnv if available
if command -v direnv &> /dev/null; then
  eval "$(direnv hook zsh)"
fi

# Normal files to source
# zsh_add_file "zsh-exports"
# zsh_add_file "zsh-prompt"

# Plugins
# zsh_add_plugin "kiurchv/asdf.plugin.zsh"
# zsh_add_plugin "olets/zsh-abbr"
# zsh_add_plugin "romkatv/powerlevel10k"
# zsh_add_plugin "unixorn/fzf-zsh-plugin"
# zsh_add_plugin "zsh-users/zsh-autosuggestions"
# zsh_add_plugin "zsh-users/zsh-syntax-highlighting"
# zsh_add_completion "esc/conda-zsh-completion" false
# For more plugins: https://github.com/unixorn/awesome-zsh-plugins
# More completions https://github.com/zsh-users/zsh-completions


# # Enable the completion system
# autoload compinit

# # Initialize all completions on $fpath and ignore (-i) all insecure files and directories
# compinit -i

# Define key bindings.
# z4h bindkey z4h-cd-back    Shift+Left   # cd into the previous directory
# z4h bindkey z4h-cd-forward Shift+Right  # cd into the next directory
# z4h bindkey z4h-cd-up      Shift+Up     # cd into the parent directory
# z4h bindkey z4h-cd-down    Shift+Down   # cd into a child directory

# Autoload functions.
# autoload -Uz zmv

# Add flags to existing aliases.
alias ls="${aliases[ls]:-ls} -A"

# Set shell options: http://zsh.sourceforge.net/Doc/Release/Options.html.
# Awesome cd movements from zshkit
setopt autocd autopushd pushdminus pushdsilent pushdtohome cdablevars
DIRSTACKSIZE=5

# Shell options
ulimit -n 8192
unsetopt nomatch
setopt auto_cd
setopt extendedglob  # enable extended globbing
setopt glob_dots     # no special treatment for file names with a leading dot
setopt interactive_comments
setopt no_auto_menu  # require an extra TAB press to open the completion menu

# Zoxide : prompt hook mode
if command -v zoxide &> /dev/null; then
  eval $(zoxide init zsh --hook prompt)
fi

# Initialize atuin for better history search (if available)
if command -v atuin &> /dev/null; then
  eval "$(atuin init zsh)"
fi

# pnpm
export PNPM_HOME="{{ .chezmoi.homeDir }}/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

# pnpm shell completion
if [ -f "/opt/homebrew/share/zsh/site-functions/_pnpm" ]; then
  source "/opt/homebrew/share/zsh/site-functions/_pnpm"
fi

# Terminal-specific integrations
if [[ "$TERM_PROGRAM" == "iTerm.app" ]]; then
  # Load iTerm2 shell integration only when using iTerm2
  test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"
fi
